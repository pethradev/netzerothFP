<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>A Lenda de Netzeroth</title>
  <style>
    :root{
      --bg: #0b0e14;
      --card: #111623;
      --muted: #8992a4;
      --text: #eaeefb;
      --accent: #6ea8fe;
      --accent2:#9bdbff;
      --danger:#ff6b6b;
      --ok:#33d1a0;
      --warn:#f6c177;
      --border: #22283a;
    }
    [data-theme="light"]{
      --bg:#f7f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#111827;
      --accent:#2563eb;
      --accent2:#60a5fa;
      --danger:#dc2626;
      --ok:#059669;
      --warn:#d97706;
      --border:#e5e7eb;
    }
    html,body{height:100%d}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol";
    }
    .app{
      max-width:1100px;
      margin:0 auto;
      padding:16px 16px 120px;
    }
    header.top{
      position: sticky; top:0; z-index: 5;
      background: linear-gradient(180deg, rgba(0,0,0,.35), transparent);
      backdrop-filter: blur(6px);
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
    }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}
    .brand{font-weight:800; letter-spacing:.2px}
    .muted{color:var(--muted)}
    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.04));
      color:var(--text);
      padding:8px 12px; border-radius:14px; cursor:pointer; font-weight:600;
      transition: all 0.2s ease-in-out;
    }
    .btn:hover{border-color:var(--accent); transform: translateY(-1px);}
    .btn.ghost{background:transparent}
    .btn.primary{background: linear-gradient(180deg, var(--accent2), var(--accent)); color:#0b1020; border-color: transparent;}
    .btn.destructive{border-color: transparent; background:linear-gradient(180deg, #ffb4c2, var(--danger)); color:#1d0004}
    .btn.small{padding:6px 10px; border-radius:12px; font-size:.9rem}
    select,input,textarea{
      width:100%; box-sizing:border-box; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:var(--card); color:var(--text);
    }
    textarea{min-height:110px; resize:vertical}
    .grid{
      display:grid; gap:12px;
    }
    .grid.cols-2{grid-template-columns: repeat(2, minmax(0,1fr));}
    .grid.cols-3{grid-template-columns: repeat(3, minmax(0,1fr));}
    .grid.cols-4{grid-template-columns: repeat(4, minmax(0,1fr));}
    .grid.cols-6{grid-template-columns: repeat(6, minmax(0,1fr));}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:20px; padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    .section-title{font-weight:800; margin:0 0 8px; display:flex; align-items:center; gap:10px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .tab{padding:10px 14px; border-radius:14px; cursor:pointer; border:1px solid var(--border); background:var(--card); color:var(--text);}
    .tab.active{border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent);}
    .panes{margin-top:16px}
    .pane{display:none}
    .pane.active{display:block}
    .attr-grid{display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:10px}
    .attr{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.05)); border:1px solid var(--border); padding:10px; border-radius:18px; text-align:center}
    .attr .label{font-weight:800; font-size:.95rem; margin-bottom:6px}
    .attr .val{font-size:1.8rem; font-weight:900}
    .attr .mod{font-size:1rem; font-weight:700; color:var(--muted)}
    .attr .controls{display:flex; gap:6px; justify-content:center; margin-top:8px}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); background:var(--card)}
    .subtle{color:var(--muted); font-size:.95rem}
    .warn{color:var(--warn)}
    .ok{color:var(--ok)}
    .danger{color:var(--danger)}
    .table{width:100%; border-collapse: collapse}
    .table th,.table td{border-bottom:1px dashed var(--border); padding:8px; text-align:left}
    .table th{font-size:.9rem; color:var(--muted); font-weight:700}
    #skillsTable th:first-child, #skillsTable td:first-child { width: 30%; }
    #skillsTable td input { width: 100%; }
    .inline{display:inline-flex; gap:8px; flex-wrap:wrap; align-items:center}
    .badge{border:1px solid var(--border); padding:4px 8px; border-radius:999px; font-size:.85rem; color:var(--muted)}
    .bar{height:10px; border-radius:999px; background:#00000033; overflow:hidden; border:1px solid var(--border)}
    .bar>div{height:100%; background:linear-gradient(90deg, var(--accent), var(--accent2)); width:0%}
    .kpis{display:flex; gap:12px; flex-wrap:wrap}
    .kpi{flex:1; min-width:200px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px}
    .kpi .label{font-size:.9rem; color:var(--muted)}
    .kpi .value{font-weight:900; font-size:1.4rem}
    .kpi-controls{display:flex; gap:6px; margin-top:8px;}
    .list .row{align-items:flex-start}
    .list .item{display:grid; grid-template-columns: 1fr auto; gap:8px; margin-bottom:8px; align-items:center}
    .list .item.small{grid-template-columns: 1fr auto}
    .list .item.attack{grid-template-columns: 1.3fr 1fr 1fr 1.2fr auto}
    .list .item.inventory{
      display: grid; 
      grid-template-columns: 2fr 1fr 1fr 1fr auto; 
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .list .item button{height:40px}
    .roll-log{background:var(--card); border:1px dashed var(--border); padding:10px; border-radius:12px; max-height:240px; overflow:auto}
    .footer-actions{
      position: fixed; bottom:16px; left:0; right:0;
      display:flex; justify-content:center; z-index: 10;
    }
    .footer-actions .wrap{
      display:flex; gap:8px; padding:8px; background:rgba(0,0,0,.3);
      border:1px solid var(--border); border-radius:16px; backdrop-filter: blur(6px);
    }
    .hint{font-size:.9rem; color:var(--muted)}
    .right{margin-left:auto}
    details summary{cursor:pointer; user-select:none}
    .chip{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border:1px solid var(--border); border-radius:999px}
    .hidden{display:none !important}
    .slider-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: #333;
        outline: none;
        border-radius: 4px;
        cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: var(--accent);
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid var(--text);
    }
    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: var(--accent);
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid var(--text);
    }
    .slider-value {
        font-size: 1.2rem;
        font-weight: bold;
        margin-top: 8px;
    }
    
    /* Modal/Message Box Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); z-index: 20; display: none;
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: var(--card); padding: 24px; border-radius: 20px;
      border: 1px solid var(--border); max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
      text-align: center;
    }
    .modal-content p { margin: 0 0 20px; }
    .modal-content input { margin: 10px 0; }
    .modal-buttons { display: flex; justify-content: center; gap: 10px; }

    /* Auto-save indicator */
    #autosave-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: var(--danger);
      border-radius: 50%;
      margin-right: 8px;
      transition: background-color 0.3s ease;
    }
    #autosave-indicator.saved { background-color: var(--ok); }
    
    .status-item {
        margin-bottom: 12px;
        padding: 10px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
    }
    .status-item h4 {
        margin-top: 0;
        margin-bottom: 6px;
    }
    .death-save-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }
    .test-result{
        font-size: 1.2rem;
        font-weight: bold;
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--card);
        text-align: center;
        margin-top: 8px;
    }
    .entry {
      background:var(--card); 
      border:1px solid var(--border);
      border-radius:20px; 
      padding:16px;
      margin-bottom: 12px;
    }
    .entry .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .entry .entry-header h4 {
      margin: 0;
    }
    .entry-content {
      margin-top: 12px;
      display: none; /* Inicia fechado */
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .entry-content.open {
      display: grid;
    }
    .entry-summary {
        font-size: 0.9em;
        margin-top: 8px;
        color: var(--muted);
    }
    .entry-delete-btn {
        margin-left: auto;
    }

    @media (max-width: 980px){
      .attr-grid{grid-template-columns: repeat(3, minmax(0,1fr));}
      .grid.cols-3{grid-template-columns: repeat(2, minmax(0,1fr));}
      .grid.cols-4{grid-template-columns: repeat(2, minmax(0,1fr));}
      .list .item, .list .item.attack, .list .item.small, .list .item.inventory{grid-template-columns: 1fr !important}
    }
    /* Print */
    @media print{
      body {
        background: #fff;
        color: #000;
        font-family: 'Times New Roman', Times, serif;
      }
      .card {
        box-shadow: none;
        border-color: #ccc;
        page-break-inside: avoid;
        margin-bottom: 1em;
      }
      .app {
        padding: 0;
      }
      header.top, .tabs, .footer-actions, .hint, .btn, .controls, .list button {
        display: none !important;
      }
      input, textarea, select {
        border: 1px dashed #999;
        background: transparent;
        color: #000;
      }
      .table th, .table td {
        border-color: #999;
      }
      .table {
        border: 1px solid #999;
      }
      .table th {
        background: #eee;
      }
      .section-title {
        color: #000;
      }
      .pill, .badge {
        border: 1px solid #ccc;
        background: #eee;
        color: #000;
      }
      /* Prevent elements from breaking across pages */
      .card, .table, .list .item {
        page-break-inside: avoid;
      }
      @page {
        margin: 1.5cm;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <div class="modal-overlay" id="message-modal">
    <div class="modal-content">
      <p id="message-text"></p>
      <div class="modal-buttons">
        <button class="btn primary" id="message-ok">OK</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="prompt-modal">
    <div class="modal-content">
      <p id="prompt-text"></p>
      <input type="text" id="prompt-input">
      <div class="modal-buttons">
        <button class="btn" id="prompt-cancel">Cancelar</button>
        <button class="btn primary" id="prompt-ok">OK</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="confirm-modal">
    <div class="modal-content">
      <p id="confirm-text"></p>
      <div class="modal-buttons">
        <button class="btn" id="confirm-no">N√£o</button>
        <button class="btn destructive" id="confirm-yes">Sim</button>
      </div>
    </div>
  </div>

  <header class="top">
    <div class="row">
      <div class="brand">üìú A Lenda de Netzeroth - Ficha de Personagem</div>
      <div class="right inline">
        <select id="characterSelect" class="chip"><option value="irx2fbn">Novo Personagem</option></select>
        <button class="btn small" id="newCharBtn">Novo</button>
        <button class="btn small" id="dupCharBtn">Duplicar</button>
        <button class="btn small destructive" id="delCharBtn">Excluir</button>
        <button class="btn small" id="exportBtn">Exportar</button>
        <label class="btn small" for="importFile">Importar</label>
        <input id="importFile" type="file" accept="application/json" class="hidden">
        <button class="btn small" id="printBtn">Imprimir</button>
        <button class="btn small" id="themeBtn">Tema</button>
      </div>
    </div>
    <div class="tabs" id="tabs"><button class="tab active" data-open="1">Cabe√ßalho + Atributos</button><button class="tab" data-open="2">Skills + Indicadores</button><button class="tab" data-open="3">Combate + Classes</button><button class="tab" data-open="4">Invent√°rio</button><button class="tab" data-open="5">Hist√≥ria + Notas</button><button class="tab" data-open="6">Lore & Recompensas</button><button class="tab" data-open="7">Hist√≥rico de Campanhas</button></div>
  </header>

  <div class="app">
    <div class="panes">
      <section class="pane active" data-pane="1">
        <div class="grid cols-3">
          <div class="card">
            <h3 class="section-title">ü™™ Cabe√ßalho</h3>
            <div class="grid cols-2">
              <div><label>Nome do Personagem<input id="nome"></label></div>
              <div><label>Jogador<input id="jogador"></label></div>
              <div>
                <label>Classe</label>
                <select id="classe">
                  <option value="">-- Selecione --</option>
                  <option value="Guardi√£o">Guardi√£o</option>
                  <option value="Arauto">Arauto</option>
                  <option value="Curandeiro">Curandeiro</option>
                  <option value="Ca√ßador de Sombras">Ca√ßador de Sombras</option>
                  <option value="M√≠stico">M√≠stico</option>
                  <option value="Peregrino">Peregrino</option>
                </select>
              </div>
              <div>
                <label>Esp√©cie</label>
                <select id="especie" onchange="atualizarEspecie()">
                  <option value="">-- Selecione --</option>
                  <option value="humano">Humano</option>
                  <option value="alvorecido">Alvorecido</option>
                  <option value="errante">Errante</option>
                  <option value="auralino">Auralino</option>
                  <option value="vigia">Vigia</option>
                  <option value="ferino">Ferino</option>
                </select>
              </div>
              <div id="infoEspecie" style="margin-top:1em; font-size:0.9em; background:var(--border); padding:1em; border-radius:12px;">Selecione uma esp√©cie para ver os detalhes.</div>
              <div><label>Tra√ßo √önico da Esp√©cie<input id="traco"></label></div>
              <div><label>N√≠vel<input id="nivel" type="number" min="1" max="20" value="1"></label></div>
              <div>
                <label>Alinhamento
                  <select id="alinhamento">
                    <option value="Fiel">Fiel</option>
                    <option value="Curioso">Curioso</option>
                    <option value="Vacilante">Vacilante</option>
                    <option value="Tentado">Tentado</option>
                    <option value="Ne√≥fito">Ne√≥fito</option>
                  </select>
                </label>
              </div>
              <div>
                <label>Regi√£o de Origem</label>
                <select id="regiaoOrigem">
                  <option value="">-- Selecione --</option>
                  <option value="Haravoth">Haravoth - Campos de Multid√µes</option>
                  <option value="Ashkar">Ashkar - Terras Queimadas</option>
                  <option value="Neveloth">Neveloth - Vales Enevoados</option>
                  <option value="Metsudoth">Metsudoth - Cidades-Muralha</option>
                  <option value="Neharim">Neharim - Mercados e Rios Largos</option>
                  <option value="Qadmiar">Qadmiar - Deserto Antigo</option>
                  <option value="Yam Talorah">Yam Talorah - Mar da Can√ß√£o</option>
                  <option value="Gan-Eved">Gan-Eved - O Jardim Perdido</option>
                </select>
              </div>
              <label>Talento Regional (b√¥nus de origem)<textarea id="talentoRegional" placeholder="Ex: Conhecimento Popular, Resist√™ncia √†s Cinzas"></textarea></label>
            </div>
            <div class="hint" id="autosave" style="opacity: 0.6; display: flex; align-items: center;"><span id="autosave-indicator"></span><span id="autosave-text">Salvando...</span></div>
          </div>

          <div class="card">
            <h3 class="section-title">üßÆ Regras de Distribui√ß√£o</h3>
            <div class="grid">
              <div class="inline">
                <span class="badge">Pontos iniciais: <b id="ptsIniciais">10</b></span>
                <span class="badge">B√¥nus por 1 atributo em 6: <b id="bonusSeis">+2</b></span>
                <span class="badge">M√≠n/M√°x atributo: <b>6‚Äì20</b></span>
              </div>
              <div class="inline">
                <span class="pill" style="border-color: var(--border);">Pontos restantes: <b id="pontosRestantes">10</b></span>
              </div>
              <div class="pill" id="requisitoFalha" style="display: none; background: #c63333; color: white; border: none;"><span>‚ö†Ô∏è</span> Falha: Exige ao menos 1 atributo em 7 ou 8</div>
              <div class="hint">Regra assumida: baixar qualquer atributo para <b>6</b> concede <b>+2</b> pontos extras uma √∫nica vez. Voc√™ tamb√©m deve ter ao menos <b>um atributo em 7 ou 8</b>. Aumentar acima de 10 consome 1 ponto por n√≠vel. Ajuste no menu ‚öôÔ∏è se quiser mudar.</div>
              <details>
                <summary>‚öôÔ∏è Ajustes r√°pidos</summary>
                <div class="grid cols-3">
                  <label>Pontos iniciais<input type="number" id="cfg_pts" min="0" value="10"></label>
                  <label>B√¥nus ao ter um 6<input type="number" id="cfg_bonus6" min="0" value="2"></label>
                  <label>For√ßar 1 atributo em 7/8?
                    <select id="cfg_falha">
                      <option value="true">Sim</option>
                      <option value="false">N√£o</option>
                    </select>
                  </label>
                </div>
              </details>
            </div>
          </div>

          <div class="card">
            <h3 class="section-title">‚ú® O Selo do Rei</h3>
            <p class="hint">Todos os personagens s√£o Portadores do Selo de Elyon, mas isso n√£o significa que sejam iguais. O Selo √© um v√≠nculo espiritual com Elyon, que se manifesta de forma √∫nica em cada indiv√≠duo. Ele pode ser uma marca na pele, um objeto simb√≥lico ou uma luz nos olhos.</p>
            <ul>
              <li>Permite sentir a presen√ßa de corrup√ß√£o ou b√™n√ß√£o.</li>
              <li>Concede vantagem em um teste de F√â por sess√£o.</li>
              <li>Reconhecido por aliados de Elyon e temido pelas Sombras.</li>
            </ul>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 class="section-title">üß± Atributos</h3>
          <div class="attr-grid" id="attrGrid">
            <div class="attr">
              <div class="label" title="Poder f√≠sico">For√ßa <span class="muted">(FOR)</span></div>
              <div class="val" id="val_FOR" data-val="10">10</div>
              <div class="mod"><span class="badge" id="mod_FOR">mod +0</span></div>
              <div class="controls">
                <button class="btn small" data-k="FOR" data-d="-1">‚àí</button>
                <button class="btn small" data-k="FOR" data-d="+1">+</button>
              </div>
            </div>
            <div class="attr">
              <div class="label" title="Reflexos, destreza">Agilidade <span class="muted">(AGI)</span></div>
              <div class="val" id="val_AGI" data-val="10">10</div>
              <div class="mod"><span class="badge" id="mod_AGI">mod +0</span></div>
              <div class="controls">
                <button class="btn small" data-k="AGI" data-d="-1">‚àí</button>
                <button class="btn small" data-k="AGI" data-d="+1">+</button>
              </div>
            </div>
            <div class="attr">
              <div class="label" title="Resist√™ncia f√≠sica">Vigor <span class="muted">(VIG)</span></div>
              <div class="val" id="val_VIG" data-val="10">10</div>
              <div class="mod"><span class="badge" id="mod_VIG">mod +0</span></div>
              <div class="controls">
                <button class="btn small" data-k="VIG" data-d="-1">‚àí</button>
                <button class="btn small" data-k="VIG" data-d="+1">+</button>
              </div>
            </div>
            <div class="attr">
              <div class="label" title="Intelig√™ncia e estrat√©gia">Ast√∫cia <span class="muted">(AST)</span></div>
              <div class="val" id="val_AST" data-val="10">10</div>
              <div class="mod"><span class="badge" id="mod_AST">mod +0</span></div>
              <div class="controls">
                <button class="btn small" data-k="AST" data-d="-1">‚àí</button>
                <button class="btn small" data-k="AST" data-d="+1">+</button>
              </div>
            </div>
            <div class="attr">
              <div class="label" title="Percep√ß√£o, intui√ß√£o">Sabedoria <span class="muted">(SAB)</span></div>
              <div class="val" id="val_SAB" data-val="10">10</div>
              <div class="mod"><span class="badge" id="mod_SAB">mod +0</span></div>
              <div class="controls">
                <button class="btn small" data-k="SAB" data-d="-1">‚àí</button>
                <button class="btn small" data-k="SAB" data-d="+1">+</button>
              </div>
            </div>
            <div class="attr">
              <div class="label" title="Influ√™ncia social">Carisma <span class="muted">(CAR)</span></div>
              <div class="val" id="val_CAR" data-val="10">10</div>
              <div class="mod"><span class="badge" id="mod_CAR">mod +0</span></div>
              <div class="controls">
                <button class="btn small" data-k="CAR" data-d="-1">‚àí</button>
                <button class="btn small" data-k="CAR" data-d="+1">+</button>
              </div>
            </div>
            <div class="attr">
              <div class="label" title="Poder espiritual">F√© <span class="muted">(FE)</span></div>
              <div class="val" id="val_FE" data-val="10">10</div>
              <div class="mod"><span class="badge" id="mod_FE">mod +0</span></div>
              <div class="controls">
                <button class="btn small" data-k="FE" data-d="-1">‚àí</button>
                <button class="btn small" data-k="FE" data-d="+1">+</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="pane" data-pane="2">
        <div class="grid cols-2">
          <div class="card">
            <h3 class="section-title">üî™ Skills</h3>
            <div class="inline" style="margin-bottom:12px">
              <span class="badge">B√¥nus por Treino: <b>+2</b></span>
              <span class="badge">B√¥nus por Especializa√ß√£o: <b>+4</b></span>
              <span class="badge">C√°lculo: (Mod Atributo) + (B√¥nus) + (Extra)</span>
              <button class="btn small" id="addSkillBtn">‚ûï Nova Skill</button>
            </div>
            <table class="table" id="skillsTable">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Atributo</th>
                  <th title="Treinada">Treino</th>
                  <th>Espec.</th>
                  <th>Extra</th>
                  <th>Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="skillsBody">
                </tbody>
            </table>
            <details style="margin-top: 12px;">
              <summary>Lista Oficial de Skills</summary>
              <div class="grid">
                <div>
                  <h4 style="margin-bottom: 4px;">For√ßa (FOR)</h4>
                  <ul>
                    <li><b>Atletismo:</b> Corrida, escalada, nata√ß√£o.</li>
                    <li><b>Briga:</b> Luta desarmada, agarr√µes.</li>
                    <li><b>Quebra e For√ßa Bruta:</b> Abrir portas, mover objetos pesados.</li>
                  </ul>
                </div>
                <div>
                  <h4 style="margin-bottom: 4px;">Agilidade (AGI)</h4>
                  <ul>
                    <li><b>Acrobacia:</b> Saltos, rolamentos, equil√≠brio.</li>
                    <li><b>Furtividade:</b> Andar sem ser notado, esconder-se.</li>
                    <li><b>Prestidigita√ß√£o:</b> Movimentos r√°pidos de m√£os.</li>
                  </ul>
                </div>
                <div>
                  <h4 style="margin-bottom: 4px;">Vigor (VIG)</h4>
                  <ul>
                    <li><b>Resist√™ncia:</b> Suportar cansa√ßo, fome, sede.</li>
                    <li><b>Fortitude:</b> Resistir a venenos e doen√ßas.</li>
                    <li><b>Marcha For√ßada:</b> Longas viagens sem descanso.</li>
                  </ul>
                </div>
                <div>
                  <h4 style="margin-bottom: 4px;">Ast√∫cia (AST)</h4>
                  <ul>
                    <li><b>Investiga√ß√£o:</b> Resolver enigmas, buscar padr√µes.</li>
                    <li><b>Estrat√©gia:</b> Planejar batalhas, antecipar movimentos.</li>
                    <li><b>Engana√ß√£o:</b> Mentir, disfar√ßar inten√ß√µes.</li>
                  </ul>
                </div>
                <div>
                  <h4 style="margin-bottom: 4px;">Sabedoria (SAB)</h4>
                  <ul>
                    <li><b>Percep√ß√£o:</b> Detectar armadilhas, notar detalhes.</li>
                    <li><b>Sobreviv√™ncia:</b> Encontrar recursos naturais, rastrear.</li>
                    <li><b>Empatia:</b> Ler emo√ß√µes e inten√ß√µes.</li>
                  </ul>
                </div>
                <div>
                  <h4 style="margin-bottom: 4px;">Carisma (CAR)</h4>
                  <ul>
                    <li><b>Persuas√£o:</b> Convencer, negociar, inspirar.</li>
                    <li><b>Intimida√ß√£o:</b> Amedrontar ou for√ßar obedi√™ncia.</li>
                    <li><b>Performance:</b> Cantar, discursar, entreter.</li>
                  </ul>
                </div>
                <div>
                  <h4 style="margin-bottom: 4px;">F√© (F√â)</h4>
                  <ul>
                    <li><b>Resist√™ncia √† Corrup√ß√£o:</b> Suportar tenta√ß√µes sombrias.</li>
                    <li><b>Canaliza√ß√£o de B√™n√ß√£os:</b> Ativar efeitos sagrados.</li>
                    <li><b>Liturgia:</b> Conduzir rituais e interpretar sinais divinos.</li>
                  </ul>
                </div>
              </div>
            </details>
          </div>
          <div class="grid">
            <div class="card">
              <h3 class="section-title">‚ö° Indicadores B√°sicos</h3>
              <div class="grid cols-2">
                <div class="kpi">
                  <div class="label">Pontos de Vida (PV)</div>
                  <div class="value" id="kpi_pv">10 / 10</div>
                  <div class="bar"><div id="bar_pv"></div></div>
                  <div class="inline">
                    <label>Total<input type="number" id="cur_pv" min="0" value="10"></label>
                    <label>Meta<input type="number" id="max_pv" min="0" value="10"></label>
                  </div>
                </div>
                <div class="kpi">
                  <div class="label">Pontos Espirituais (PE)</div>
                  <div class="value" id="kpi_pe">10 / 10</div>
                  <div class="bar"><div id="bar_pe"></div></div>
                  <div class="inline">
                    <label>Total<input type="number" id="cur_pe" min="0" value="10"></label>
                    <label>Meta<input type="number" id="max_pe" min="0" value="10"></label>
                  </div>
                </div>
                <div class="kpi">
                  <div class="label">Pontos de A√ß√£o (PA)</div>
                  <div class="value" id="kpi_pa">10 / 10</div>
                  <div class="bar"><div id="bar_pa"></div></div>
                  <div class="inline">
                    <label>Total<input type="number" id="cur_pa" min="0" value="10"></label>
                    <label>Meta<input type="number" id="max_pa" min="0" value="10"></label>
                  </div>
                </div>
                <div class="kpi">
                  <div class="label">XP</div>
                  <div class="value" id="kpi_xp">0 / 1000</div>
                  <div class="bar"><div id="bar_xp"></div></div>
                  <div class="inline">
                    <label>Total<input type="number" id="cur_xp" min="0" value="0"></label>
                    <label>Meta<input type="number" id="max_xp" min="0" value="1000"></label>
                  </div>
                </div>
              </div>
              
              <div class="card" style="margin-top: 12px;">
                <h3 class="section-title">N√≠vel de Corrup√ß√£o</h3>
                <div class="slider-container">
                  <input type="range" id="corrupcaoSlider" min="0" max="10" value="0">
                  <div class="slider-value" id="corrupcaoValue">0 / 10</div>
                </div>
                <div class="hint" id="corrupcaoEffects">
                  <!-- Efeitos da corrup√ß√£o ser√£o injetados aqui via JS -->
                </div>
              </div>
            </div>
            
            <div class="card" style="margin-top: 12px;">
              <h3 class="section-title">‚öîÔ∏è Ataques</h3>
              <div class="hint" style="margin-bottom: 12px;">
                Dano: ex. 1d8 + [FOR] ou 2d6 + 1. B√¥nus de Ataque pode ser manual ou baseado em atributo.
              </div>
              <div class="list" id="attacksList">
                </div>
              <button class="btn small" id="addAttackBtn">‚ûï Novo Ataque</button>
            </div>
          </div>
        </div>
      </section>

      <section class="pane" data-pane="3">
        <div class="grid cols-2">
          <div class="card">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bolt"><path d="M21 16V8a2 2 0 0 0-2-2h-5.24a2 2 0 0 1-1.42-.58L9 2h-.5a2 2 0 0 0-1.66.9L3 14h6.52a2 2 0 0 1 1.66 1.1l-.82 1.94A2 2 0 0 0 12.35 18h2.3a2 2 0 0 1 1.7.92L19 22h.5a2 2 0 0 0 1.66-2.9l-1.93-4.54a2 2 0 0 1-.23-1.07Z"/></svg>
              Iniciativa
            </h3>
            <div class="grid cols-2">
              <label>
                B√¥nus adicional
                <input type="number" id="bonusIniciativa" value="0">
              </label>
              <label>
                Total (auto)
                <input type="number" id="totalIniciativa" value="0" readonly>
              </label>
            </div>
            <button class="btn primary" id="rollIniciativaBtn" style="margin-top: 12px;">Rolar Iniciativa</button>
          </div>
          <div class="card">
            <h3 class="section-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-footprints"><path d="M4 16v-2.3C4 11.23 5.23 10 6.7 10c.8 0 1.5.4 2 .8c.5-.4 1.2-.8 2-.8 1.47 0 2.7 1.23 2.7 2.7v2.3"/><path d="M10 12h3"/><path d="M17.3 10c1.47 0 2.7 1.23 2.7 2.7v2.3"/><path d="M16 16v-2.3c0-1.47-1.23-2.7-2.7-2.7-.8 0-1.5.4-2 .8-.5-.4-1.2-.8-2-.8-1.47 0-2.7 1.23-2.7 2.7v2.3"/><path d="M7 16V8a2 2 0 0 1 2-2h1"/><path d="M17 16V8a2 2 0 0 0-2-2h-1"/><path d="M7 22h.01"/><path d="M17 22h.01"/><path d="M12 10V6a2 2 0 0 0-2-2H8.3a2 2 0 0 0-1.7 1L3 11"/><path d="M12 10V6a2 2 0 0 1 2-2h1.7a2 2 0 0 1 1.7 1L21 11"/></svg>
              Velocidade
            </h3>
            <div class="grid">
              <label>
                m/turno
                <input type="number" id="velocidade" value="9">
              </label>
            </div>
          </div>
        </div>
        
        <div class="grid cols-2" style="margin-top: 12px;">
          <div class="card">
            <h3 class="section-title">üìú Habilidades de Classe</h3>
            <div class="list" id="classesList">
              </div>
            <button class="btn small" id="addClasseBtn">‚ûï Nova Habilidade</button>
          </div>
          <div class="card">
            <h3 class="section-title">‚ú® B√™n√ß√£os e Dons</h3>
            <div class="list" id="bencaosList">
              </div>
            <button class="btn small" id="addBencaoBtn">‚ûï Nova B√™n√ß√£o</button>
          </div>
        </div>
        
        <div class="grid cols-2" style="margin-top: 12px;">
            <div class="card">
                <h3 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list"><rect width="8" height="4" x="8" y="2"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
                    Condi√ß√µes de Combate
                </h3>
                <label>Condi√ß√£o Atual
                    <select id="currentCondition">
                        <option value="Saud√°vel">Saud√°vel</option>
                        <option value="Atordoado">Atordoado</option>
                        <option value="Envenenado">Envenenado</option>
                        <option value="Imobilizado">Imobilizado</option>
                        <option value="Inspirado">Inspirado</option>
                        <option value="Amedrontado">Amedrontado</option>
                    </select>
                </label>
                <div class="status-item" style="margin-top: 12px;">
                    <h4>Efeitos</h4>
                    <ul id="conditionEffects" class="hint">
                        <li><b>Saud√°vel:</b> Nenhuma condi√ß√£o especial.</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <h3 class="section-title">üé≤ Testes de Resist√™ncia √† Morte</h3>
                <p class="hint">Quando seu PV chega a 0, voc√™ faz testes de Vigor para n√£o morrer. Seus sucessos e falhas s√£o contados abaixo.</p>
                <div class="grid cols-2" style="margin-top: 12px;">
                    <div>
                        <p class="ok">Sucessos: <b id="deathSavesSuccess">0</b></p>
                        <div class="death-save-controls">
                            <button class="btn small primary" id="addDeathSuccess">‚ûï</button>
                            <button class="btn small destructive" id="minusDeathSuccess">‚ûñ</button>
                        </div>
                    </div>
                    <div>
                        <p class="danger">Falhas: <b id="deathSavesFail">0</b></p>
                        <div class="death-save-controls">
                            <button class="btn small primary" id="addDeathFail">‚ûï</button>
                            <button class="btn small destructive" id="minusDeathFail">‚ûñ</button>
                        </div>
                    </div>
                    <div style="grid-column: span 2; display: flex; justify-content: center; gap: 8px; margin-top: 12px;">
                        <button class="btn primary" id="rollDeathSaveBtn">Rolar Teste</button>
                        <button class="btn destructive" id="resetDeathSavesBtn">Resetar</button>
                    </div>
                </div>
                <div class="hint" style="margin-top: 12px;">
                    <b>Sucesso (DF 10):</b> Marca um sucesso. Com <b>3 sucessos</b>, voc√™ estabiliza.
                    <br>
                    <b>Falha (abaixo de 10):</b> Marca uma falha. Com <b>3 falhas</b>, voc√™ morre.
                    <br>
                    Um <b>20 natural</b> conta como 2 sucessos. Um <b>1 natural</b> conta como 2 falhas.
                </div>
                <label style="margin-top: 12px;">√öltima Rolagem
                    <div class="test-result" id="deathRoll"></div>
                </label>
            </div>
        </div>
      </section>

      <section class="pane" data-pane="4">
        <div class="grid cols-2">
          <div class="card">
            <h3 class="section-title">üéí Invent√°rio</h3>
            <div class="inline" style="margin-bottom:12px; font-weight: 600;">
              Capacidade (VIG x 5 slots): <b id="totalSlotsCap">0</b> slots
              <span style="margin-left: 20px;">Slots ocupados: <b id="slotsOcupados">0</b></span>
            </div>
            <div class="list" id="itemsList">
              </div>
            <div class="hint" style="margin-top:10px">
              Cada item m√©dio/padr√£o (espada, mochila pequena, etc.) ocupa <b>3 slots</b>. Itens grandes (escudo grande, arco longo) ocupam <b>5 slots</b>.  Recursos ( Corda de Vinhas, Kit de Sobreviv√™ncia) ocupam <b>1 slot</b>. 5 miudezas (frascos, mapas) agrupam-se em <b>1 slot</b>.
            </div>
            <button class="btn small" id="addItemBtn">‚ûï Adicionar Item</button>
          </div>
           <div class="card">
            <h3 class="section-title">üí∞ Dracmas</h3>
            <label for="dracmas" class="label" style="font-size: 1rem; color: var(--muted);">Total</label>
            <input type="number" id="dracmas" min="0" value="20" style="font-weight:900; font-size:2rem; padding-left: 0; background:transparent; border:none; color:var(--text); width:100%; margin-top: 8px;">
          </div>
        </div>
      </section>

      <section class="pane" data-pane="5">
        <div class="grid cols-2">
          <div class="card">
            <h3 class="section-title">üñãÔ∏è Hist√≥ria</h3>
            <div class="grid">
              <label>Origem<textarea id="historia_origem"></textarea></label>
              <label>Votos ou Prop√≥sitos<textarea id="historia_votos"></textarea></label>
              <label>Relacionamentos Importantes<textarea id="historia_relacionamentos"></textarea></label>
              <label>Eventos Marcantes<textarea id="historia_eventos"></textarea></label>
            </div>
          </div>
          
          <div class="card">
            <h3 class="section-title">üìù Notas & Condi√ß√µes</h3>
            <label>Notas de Sess√£o<textarea id="notas" placeholder="Anota√ß√µes da aventura."></textarea></label>
            <label style="margin-top: 12px; display: block;">Condi√ß√µes Atuais (separe por v√≠rgula)<textarea id="condicoes" placeholder="ferido, inspirado, corrompido"></textarea></label>
            <details style="margin-top: 12px;">
              <summary>Condi√ß√µes Comuns (Efeitos)</summary>
              <ul>
                <li><b>Atordoado:</b> Perde o pr√≥ximo turno.</li>
                <li><b>Envenenado:</b> -2 em testes f√≠sicos at√© ser curado.</li>
                <li><b>Imobilizado:</b> N√£o pode se mover.</li>
                <li><b>Inspirado:</b> Vantagem no pr√≥ximo teste.</li>
                <li><b>Amedrontado:</b> Desvantagem contra a fonte do medo.</li>
              </ul>
            </details>
            <label style="margin-top: 12px; display: block;">Pontos de Experi√™ncia Espiritual<input type="number" id="pts_exp_espiritual" min="0" value="0"></label>
            
            <h3 class="section-title" style="margin-top: 20px;">üé≤ Hist√≥rico de Rolagens</h3>
            <div class="roll-log" id="rollLog"></div>
          </div>
        </div>
      </section>

      <section class="pane" data-pane="6">
        <div class="grid cols-2">
          <div class="card">
            <h3 class="section-title">üó∫Ô∏è Regi√µes de Netzeroth</h3>
            <div class="grid" id="regioesLore">
              <!-- Conte√∫do da lore de regi√µes ser√° injetado aqui via JS -->
            </div>
          </div>
          <div class="card">
            <h3 class="section-title">ü§ù Favores de Ordem</h3>
            <p class="hint">Rastreie sua reputa√ß√£o com as Ordens Livres.</p>
            <div class="list" id="favoresOrdemList">
              <!-- Favores de Ordem ser√£o adicionados aqui via JS -->
            </div>
            <button class="btn small" id="addFavorOrdemBtn">‚ûï Adicionar Favor de Ordem</button>

            <h3 class="section-title" style="margin-top: 20px;">‚ú® B√™n√ß√£os Comuns de Elyon</h3>
            <div class="grid" id="bencaosComunsLore">
              <!-- Conte√∫do da lore de b√™n√ß√£os comuns ser√° injetado aqui via JS -->
            </div>
          </div>
        </div>
      </section>

      <section class="pane" data-pane="7">
          <div class="card">
              <h3 class="section-title">üìù Hist√≥rico de Campanhas</h3>
              <p class="hint">Use esta se√ß√£o para registrar o progresso do seu personagem em cada campanha.</p>
              
              <div id="new-campaign-form" class="entry" style="display: none;">
                  <div class="entry-content open">
                      <label>Nome da Campanha<input type="text" id="new-campaign-name"></label>
                      <label>Data<input type="date" id="new-campaign-date"></label>
                      <label>Resumo da Partida<textarea id="new-campaign-summary" placeholder="O que aconteceu nesta partida?"></textarea></label>
                      <label>Como o Personagem Contribuiu<textarea id="new-character-contribution" placeholder="O que seu personagem fez para influenciar a hist√≥ria?"></textarea></label>
                      <label>Como a Hist√≥ria o Evoluiu<textarea id="new-character-evolution" placeholder="O que seu personagem aprendeu, ganhou ou mudou?"></textarea></label>
                      <div class="row" style="margin-top: 12px; justify-content: flex-end;">
                          <button class="btn destructive" id="cancelNewEntryBtn">Cancelar</button>
                          <button class="btn primary" id="saveNewEntryBtn">Salvar Registro</button>
                      </div>
                  </div>
              </div>
              
              <div id="campaignHistory">
                  <!-- Entradas de hist√≥rico ser√£o adicionadas aqui via JS -->
              </div>
              
              <div class="row">
                  <button class="btn small" id="addCampaignEntryBtn">‚ûï Adicionar Nova Entrada</button>
              </div>
          </div>
      </section>

    </div>
  </div>

  <div class="footer-actions">
    <div class="wrap">
      <button class="btn primary" id="saveBtn">Salvar Manualmente</button>
    </div>
  </div>

  <script>
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    const SKILL_ATTRS = ["FOR", "AGI", "VIG", "AST", "SAB", "CAR", "FE"];
    const ATTRIBUTES = ["FOR", "AGI", "VIG", "AST", "SAB", "CAR", "FE"];
    const MIN_ATTR = 6;
    const MAX_ATTR = 20;

    let currentId = 'default';
    let characterData = {};
    let saveTimeout = null;

    const conditionEffectsData = {
        'Saud√°vel': 'Nenhuma condi√ß√£o especial.',
        'Atordoado': 'Perde o pr√≥ximo turno.',
        'Envenenado': '‚Äì2 em testes f√≠sicos at√© ser curado.',
        'Imobilizado': 'N√£o pode se mover.',
        'Inspirado': 'Vantagem no pr√≥ximo teste.',
        'Amedrontado': 'Desvantagem contra a fonte do medo.'
    };
    
    const regioesLoreData = [
      { name: "Haravoth", desc: "Plan√≠cies f√©rteis. Povos n√¥mades e agricultores. Perigos: Invasores e criaturas das sombras. Inspira: Comunidades unidas, coragem simples e sabedoria popular." },
      { name: "Ashkar", desc: "Solo coberto por cinzas eternas. Sobreviventes endurecidos, ca√ßadores de rel√≠quias. Perigos: Tempestades de cinzas, ru√≠nas amaldi√ßoadas. Inspira: Resist√™ncia e supera√ß√£o." },
      { name: "Neveloth", desc: "Montanhas envoltas em bruma constante. Alde√µes isolados, monges e ermit√µes. Perigos: Vozes que atraem viajantes para perder-se. Inspira: Mist√©rio, sil√™ncio e busca interior." },
      { name: "Metsudoth", desc: "Fortalezas de pedra, muralhas imensas. Guerreiros disciplinados, mestres estrategistas. Perigos: Cercos prolongados, trai√ß√µes internas. Inspira: Honra, defesa e estrat√©gia." },
      { name: "Neharim", desc: "Cidades comerciais e rotas fluviais. Comerciantes, diplomatas, artes√£os. Perigos: Corrup√ß√£o, intrigas pol√≠ticas, contrabandistas. Inspira: Negocia√ß√£o, ast√∫cia e alian√ßas improv√°veis." },
      { name: "Qadmiar", desc: "Areias douradas, dunas eternas, ru√≠nas soterradas. N√¥mades, guardi√µes de saberes antigos. Perigos: Temp. de areia, miragens, criaturas ocultas. Inspira: Perseveran√ßa, sabedoria e descoberta." },
      { name: "Yam Talorah", desc: "Oceanos profundos e ilhas distantes. Marinheiros, pescadores, exploradores. Perigos: Temp. s√∫bitas, melodias sedutoras das √°guas. Inspira: Liberdade, explora√ß√£o e mist√©rio." },
      { name: "Gan-Eved", desc: "Florestas exuberantes, rios cristalinos. Criaturas raras e territoriais, caminhos mutantes. Perigos: Criaturas raras e territoriais. Inspira: Beleza, prote√ß√£o e conex√£o com a cria√ß√£o." },
    ];

    const bencaosComunsLoreData = [
      { name: "Luz do Caminho", effect: "+2 em testes de Percep√ß√£o e Sobreviv√™ncia em regi√µes sombrias.", duration: "1 sess√£o" },
      { name: "Escudo Invis√≠vel", effect: "Reduz o dano de um ataque em 50%.", duration: "1 vez" },
      { name: "Cora√ß√£o Inabal√°vel", effect: "Imune a efeitos de medo e intimida√ß√£o.", duration: "At√© o amanhecer" },
      { name: "Voz de Autoridade", effect: "Vantagem em um teste de Persuas√£o.", duration: "1 vez" },
      { name: "M√£os Restauradoras", effect: "Cura instant√¢nea de 1d8 + F√â HP em um aliado.", duration: "1 vez" },
      { name: "Passos da Gra√ßa", effect: "Ignora terreno dif√≠cil ou obst√°culos leves.", duration: "1 vez" },
      { name: "Olhar Celestial", effect: "Vantagem em detectar criaturas ocultas ou armadilhas.", duration: "1 vez" },
      { name: "Resson√¢ncia de Esperan√ßa", effect: "Aliados pr√≥ximos recebem +1 em testes de F√â ou coragem.", duration: "1 vez" },
      { name: "Chama de Elyon", effect: "+1 dado extra de dano contra criaturas sombrias", duration: "1 ataque" },
      { name: "Purifica√ß√£o da Alma", effect: "Remove 1 ponto de Corrup√ß√£o", duration: "Uso imediato em local consagrado ou ap√≥s rito" },
      { name: "Prote√ß√£o do Guardi√£o", effect: "+2 DF ou absorve 1 ataque de dano", duration: "1 combate" },
      { name: "Palavra Inspiradora", effect: "+2 em teste de Persuas√£o ou Inspira√ß√£o.", duration: "1 vez" },
      { name: "For√ßa da F√©", effect: "+1 em teste de FOR ou VIG.", duration: "1 vez" },
      { name: "B√™n√ß√£o da Vis√£o", effect: "Revela pontos importantes no ambiente ou sinais ocultos.", duration: "1 vez" },
      { name: "Escudo da Luz", effect: "Absorve at√© 2 ataques de aliados pr√≥ximos.", duration: "1 vez" },
    ];
    
    const corrupcaoEffectsData = {
      '0-1': 'Manchas sutis, frio interior, vis√µes breves.',
      '2-3': '‚Äì1 em testes sociais com fi√©is; tenta√ß√£o ligada a desejo pessoal.',
      '4-5': '‚Äì2 contra efeitos de Medo da Luz; complica√ß√µes espirituais mais frequentes.',
      '6+': 'Escolhas de custo impostas pelo Mestre; falhas podem exigir sacrif√≠cio moral.',
    };

    function generateId() {
      return Math.random().toString(36).substring(2, 9);
    }

    // --- Modal Functions ---
    function showMessageBox(message) {
      const modal = $('#message-modal');
      $('#message-text').textContent = message;
      modal.style.display = 'flex';
      return new Promise(resolve => {
        $('#message-ok').onclick = () => {
          modal.style.display = 'none';
          resolve();
        };
      });
    }

    function showPromptBox(message, defaultValue = '') {
      const modal = $('#prompt-modal');
      const input = $('#prompt-input');
      const text = $('#prompt-text');
      
      text.textContent = message;
      input.value = defaultValue;
      modal.style.display = 'flex';
      
      return new Promise(resolve => {
        $('#prompt-ok').onclick = () => {
          modal.style.display = 'none';
          resolve(input.value);
        };
        $('#prompt-cancel').onclick = () => {
          modal.style.display = 'none';
          resolve(null);
        };
      });
    }

    function showConfirmBox(message) {
      const modal = $('#confirm-modal');
      $('#confirm-text').textContent = message;
      modal.style.display = 'flex';
      return new Promise(resolve => {
        $('#confirm-yes').onclick = () => {
          modal.style.display = 'none';
          resolve(true);
        };
        $('#confirm-no').onclick = () => {
          modal.style.display = 'none';
          resolve(false);
        };
      });
    }

    // --- Core Logic ---
    const getAttrMod = (attrKey) => {
      const val = parseInt($(`#val_${attrKey}`).dataset.val);
      return Math.floor((val - 10) / 2);
    };

    function updateBar(barId, current, max) {
        const bar = $(`#${barId}`);
        if (max === 0) {
            bar.style.width = '0%';
        } else {
            const percentage = (current / max) * 100;
            bar.style.width = `${Math.min(100, percentage)}%`;
        }
    }
    
    function updateKPI(kpiId) {
      const max = parseInt($(`#max_${kpiId}`).value);
      const cur = parseInt($(`#cur_${kpiId}`).value);
      $(`#kpi_${kpiId}`).textContent = `${cur} / ${max}`;
      updateBar(`bar_${kpiId}`, cur, max);
    }

    function calcSkillRowTotal(row) {
      const attr = row.querySelector(".attrSelect").value;
      const trained = row.querySelector(".trained").checked ? 2 : 0;
      const specialized = row.querySelector(".specialized").checked ? 4 : 0;
      const extra = parseInt(row.querySelector(".extra").value) || 0;
      const base = getAttrMod(attr);
      row.querySelector(".total").textContent = base + trained + specialized + extra;
    }

    function addSkillRow(name = "", attr = "FOR", trained = false, specialized = false, extra = 0) {
      const skillsBody = $('#skillsBody');
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" value="${name}"></td>
        <td>
          <select class="attrSelect">
            ${SKILL_ATTRS.map(a => `<option value="${a}" ${a === attr ? "selected" : ""}>${a}</option>`).join("")}
          </select>
        </td>
        <td><input type="checkbox" class="trained" ${trained ? "checked" : ""}></td>
        <td><input type="checkbox" class="specialized" ${specialized ? "checked" : ""}></td>
        <td><input type="number" class="extra" value="${extra}"></td>
        <td class="total">0</td>
        <td><button class="btn small destructive removeSkill">X</button></td>
      `;
      skillsBody.appendChild(tr);

      tr.querySelectorAll("input,select").forEach(el =>
        el.addEventListener("input", () => { calcSkillRowTotal(tr); autoSave(); })
      );
      tr.querySelector(".removeSkill").addEventListener("click", () => { tr.remove(); autoSave(); });
      
      calcSkillRowTotal(tr);
    }

    function recalcAllSkills() {
      $$("#skillsTable tbody tr").forEach(tr => calcSkillRowTotal(tr));
    }
    
    function addCustomSkill() {
      addSkillRow("Nova Skill");
      autoSave();
    }

    function addClasse(name = '', desc = '') {
      const classesList = $('#classesList');
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("list", "item");
      itemDiv.innerHTML = `
        <div>
          <label>Nome<input type="text" placeholder="Nome da Habilidade" value="${name}"></label>
          <label style="margin-top: 8px; display: block;">Descri√ß√£o<textarea placeholder="Descri√ß√£o da habilidade">${desc}</textarea></label>
        </div>
        <button class="btn small destructive remove-item">X</button>
      `;
      classesList.appendChild(itemDiv);
      itemDiv.querySelector("input, textarea").addEventListener("input", autoSave);
      itemDiv.querySelector(".remove-item").addEventListener("click", () => { itemDiv.remove(); autoSave(); });
      autoSave();
    }

    function addBencao(name = '', desc = '') {
      const bencaosList = $('#bencaosList');
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("list", "item");
      itemDiv.innerHTML = `
        <div>
          <label>Nome<input type="text" placeholder="Nome da B√™n√ß√£o/Dom" value="${name}"></label>
          <label style="margin-top: 8px; display: block;">Descri√ß√£o<textarea placeholder="Descri√ß√£o">${desc}</textarea></label>
        </div>
        <button class="btn small destructive remove-item">X</button>
      `;
      bencaosList.appendChild(itemDiv);
      itemDiv.querySelector("input, textarea").addEventListener("input", autoSave);
      itemDiv.querySelector(".remove-item").addEventListener("click", () => { itemDiv.remove(); autoSave(); });
      autoSave();
    }
    
    function calculateSlots() {
        let totalSlots = 0;
        const itemRows = document.querySelectorAll('#itemsList .list.item.inventory');
        itemRows.forEach(itemDiv => {
            const slotsInput = itemDiv.querySelector('.item-slots');
            const quantidadeInput = itemDiv.querySelector('.item-qtd');
            const slots = parseFloat(slotsInput.value) || 0;
            const quantidade = parseInt(quantidadeInput.value) || 0;
            totalSlots += slots * quantidade;
        });
        $('#slotsOcupados').textContent = totalSlots.toFixed(2); // Arredonda para 2 casas decimais

        const vig = parseInt($(`#val_VIG`).dataset.val);
        const maxSlots = vig * 5;
        $('#totalSlotsCap').textContent = maxSlots;
    }

    function addItem(name = '', slots = 1, type = 'recurso', quantity = 1) {
      const itemsList = $('#itemsList');
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("list", "item", "inventory");
      itemDiv.innerHTML = `
        <label>Nome<input class="item-nome" type="text" placeholder="Nome do Item" value="${name}"></label>
        <label>Slots<input class="item-slots" type="number" min="0" step="0.2" value="${slots}" style="width: 60px;"></label>
        <label>Tipo
          <select class="item-tipo">
            <option value="recurso" ${type === 'recurso' ? 'selected' : ''}>Recurso</option>
            <option value="arma" ${type === 'arma' ? 'selected' : ''}>Arma</option>
            <option value="armadura" ${type === 'armadura' ? 'selected' : ''}>Armadura</option>
            <option value="miudeza" ${type === 'miudeza' ? 'selected' : ''}>Miudeza (5 = 1 slot)</option>
          </select>
        </label>
        <label>Qtd.<input class="item-qtd" type="number" min="0" value="${quantity}" style="width: 60px;"></label>
        <button class="btn small destructive remove-item">X</button>
      `;
      itemsList.appendChild(itemDiv);

      itemDiv.querySelector(".remove-item").addEventListener("click", () => {
        itemDiv.remove();
        calculateSlots();
        autoSave();
      });
      itemDiv.querySelector(".item-nome").addEventListener("input", autoSave);
      itemDiv.querySelector(".item-slots").addEventListener("input", () => { calculateSlots(); autoSave(); });
      itemDiv.querySelector(".item-tipo").addEventListener("change", () => {
        const currentType = itemDiv.querySelector('.item-tipo').value;
        if (currentType === 'miudeza') {
            itemDiv.querySelector('.item-slots').value = 0.2;
        } else if (itemDiv.querySelector('.item-slots').value == 0.2) { 
             itemDiv.querySelector('.item-slots').value = 1;
        }
        calculateSlots();
        autoSave();
      });
      itemDiv.querySelector(".item-qtd").addEventListener("input", () => { calculateSlots(); autoSave(); });

      calculateSlots();
      autoSave();
    }

    function addAttack(name = '', bonus = '', damage = '', type = '') {
      const attacksList = $('#attacksList');
      const attackDiv = document.createElement("div");
      attackDiv.classList.add("list", "item", "attack");
      attackDiv.innerHTML = `
        <div>
          <label>Nome<input type="text" placeholder="Nome do Ataque" value="${name}"></label>
        </div>
        <div>
          <label>B√¥nus de Ataque<input type="text" placeholder="ex: [FOR] ou +5" value="${bonus}"></label>
        </div>
        <div>
          <label>Dano<input type="text" placeholder="ex: 1d8 + [NIVEL]" value="${damage}"></label>
        </div>
        <div>
          <label>Tipo<input type="text" placeholder="F√≠sico, M√°gico..." value="${type}"></label>
        </div>
        <button class="btn small destructive remove-item">X</button>
      `;
      attacksList.appendChild(attackDiv);
      attackDiv.querySelectorAll("input").forEach(el => el.addEventListener("input", autoSave));
      attackDiv.querySelector(".remove-item").addEventListener("click", () => { attackDiv.remove(); autoSave(); });
      autoSave();
    }
    
    function updatePoints() {
      const cfg_pts = parseInt($('#cfg_pts').value) || 0;
      const cfg_bonus6 = parseInt($('#cfg_bonus6').value) || 0;
      const cfg_falha = $('#cfg_falha').value === "true";

      let spentPoints = 0;
      let has6 = false;
      let has7or8 = false;

      ATTRIBUTES.forEach(attr => {
        const val = parseInt($(`#val_${attr}`).dataset.val);
        if (val === 6) {
          has6 = true;
        }
        if (val === 7 || val === 8) {
          has7or8 = true;
        }
        if (val > 10) {
          spentPoints += (val - 10);
        }
      });
      
      let bonusPoints = has6 ? cfg_bonus6 : 0;
      let remainingPoints = cfg_pts + bonusPoints - spentPoints;

      $('#pontosRestantes').textContent = remainingPoints;

      if (cfg_falha && !has7or8) {
        $('#requisitoFalha').style.display = 'inline-flex';
      } else {
        $('#requisitoFalha').style.display = 'none';
      }
    }

    function handleAttrChange(event) {
      const btn = event.target;
      const key = btn.dataset.k;
      const direction = parseInt(btn.dataset.d);
      const attrEl = $(`#val_${key}`);
      let currentVal = parseInt(attrEl.dataset.val);
      let newVal = currentVal + direction;

      if (newVal < MIN_ATTR || newVal > MAX_ATTR) {
        showMessageBox(`O atributo deve estar entre ${MIN_ATTR} e ${MAX_ATTR}.`);
        return;
      }
      
      attrEl.dataset.val = newVal;
      attrEl.textContent = newVal;

      const mod = getAttrMod(key);
      $(`#mod_${key}`).textContent = `mod ${mod > 0 ? '+' : ''}${mod}`;

      updatePoints();
      recalcAllSkills();
      updateIniciativa(); // Update initiative on AGI change
      calculateSlots(); // Update slots capacity on VIG change
      autoSave();
    }

    function updateCorrupcao() {
      const slider = $('#corrupcaoSlider');
      const valueDisplay = $('#corrupcaoValue');
      const effectsDiv = $('#corrupcaoEffects');
      const corrupcaoValue = parseInt(slider.value);
      valueDisplay.textContent = `${corrupcaoValue} / ${slider.max}`;
      
      let currentEffect = '';
      if (corrupcaoValue >= 0 && corrupcaoValue <= 1) {
        currentEffect = corrupcaoEffectsData['0-1'];
      } else if (corrupcaoValue >= 2 && corrupcaoValue <= 3) {
        currentEffect = corrupcaoEffectsData['2-3'];
      } else if (corrupcaoValue >= 4 && corrupcaoValue <= 5) {
        currentEffect = corrupcaoEffectsData['4-5'];
      } else if (corrupcaoValue >= 6) {
        currentEffect = corrupcaoEffectsData['6+'];
      }
      effectsDiv.innerHTML = `<b>Efeito atual:</b> ${currentEffect}`;

      autoSave();
    }

    function updateIniciativa() {
      const bonus = parseInt($('#bonusIniciativa').value) || 0;
      const agiMod = getAttrMod('AGI');
      const total = 10 + agiMod + bonus; // Roll 1d20, here we simulate with a base 10
      $('#totalIniciativa').value = total;
    }

    function rollIniciativa() {
      const bonus = parseInt($('#bonusIniciativa').value) || 0;
      const agiMod = getAttrMod('AGI');
      const roll = Math.floor(Math.random() * 20) + 1;
      const total = roll + agiMod + bonus;
      $('#totalIniciativa').value = total;
      const rollLog = $('#rollLog');
      const newRoll = document.createElement('div');
      newRoll.textContent = `Iniciativa: D20(${roll}) + Mod Agi(${agiMod}) + B√¥nus(${bonus}) = ${total}`;
      rollLog.prepend(newRoll);
      autoSave();
    }
    
    function atualizarEspecie() {
      const especie = $('#especie').value;
      const infoDiv = $('#infoEspecie');
      let info = '';
      switch(especie) {
        case 'humano':
          info = '<b>Humano</b><br><b>Ess√™ncia:</b> Fr√°geis, mas livres; representam esperan√ßa e reden√ß√£o.<br><b>Atributo:</b> +1 em qualquer atributo.<br><b>Tra√ßo:</b> Versatilidade ‚Üí ganha +1 skill treinada.';
          break;
        case 'alvorecido':
          info = '<b>Alvorecido</b><br><b>Ess√™ncia:</b> Seres tocados pela Luz, como ecos do √âden.<br><b>Atributo:</b> +1 F√©.<br><b>Tra√ßo:</b> Clar√£o Sagrado ‚Üí 1 vez por descanso, ilumina uma √°rea, revelando criaturas ocultas e afastando a Corrup√ß√£o menor.<br><b>Narrativa:</b> Representam esperan√ßa, mas sofrem preconceito e medo das Sombras.';
          break;
        case 'errante':
          info = '<b>Errante</b><br><b>Ess√™ncia:</b> Criaturas de apar√™ncia humana que trazem marcas sombrias, mas lutam por reden√ß√£o.<br><b>Atributo:</b> +1 Vigor ou Ast√∫cia.<br><b>Tra√ßo:</b> Marca Sombria ‚Üí Vantagem contra efeitos de medo e corrup√ß√£o; desvantagem em Persuas√£o com pessoas muito religiosas.<br><b>Narrativa:</b> S√≠mbolo da  gra√ßa e miseric√≥rdia oferecidas por Elyon aos arrependidos, lembrando que at√© na sombra h√° potencial para a luz.';
          break;
        case 'auralino':
          info = '<b>Auralino</b><br><b>Ess√™ncia:</b> Animais despertos pela Luz, com pureza moral e coragem.<br><b>Atributo:</b> +1 em um atributo coerente com a esp√©cie (For√ßa para le√£o, Agilidade para raposa).<br><b>Tra√ßo:</b> Instinto Ancestral ‚Üí Vantagem em Sobreviv√™ncia e Percep√ß√£o.<br><b>Narrativa:</b> Representam a voz da cria√ß√£o.';
          break;
        case 'vigia':
          info = '<b>Vigia</b><br><b>Ess√™ncia:</b> Pequenos seres espirituais encarnados, mensageiros da vontade divina.<br><b>Atributo:</b> +1 Sabedoria.<br><b>Tra√ßo:</b> Olhar Celestial ‚Üí Pode detectar corrup√ß√£o oculta com um teste de F√© (DF 15).<br><b>Narrativa:</b> Enviados para guiar, mas limitados pelo livre-arb√≠trio dos homens.';
          break;
        case 'ferino':
          info = '<b>Ferino</b><br><b>Ess√™ncia:</b> Seres h√≠bridos (metade homem, metade fera), descendentes de uma ordem ca√≠da, tentando restaurar a alian√ßa original.<br><b>Atributo:</b> +1 For√ßa ou Agilidade.<br><b>Tra√ßo:</b> Faro Instintivo ‚Üí Vantagem para rastrear criaturas corrompidas.<br><b>Narrativa:</b> Vivem a tens√£o entre o instinto e a f√©.';
          break;
        default:
          info = 'Selecione uma esp√©cie para ver os detalhes.';
      }
      infoDiv.innerHTML = info;
      autoSave();
    }

    function addFavorOrdem(ordem = '', nivel = 'Aliado', beneficios = '') {
      const favoresOrdemList = $('#favoresOrdemList');
      const itemDiv = document.createElement("div");
      itemDiv.classList.add("list", "item");
      itemDiv.innerHTML = `
        <div>
          <label>Ordem<input type="text" placeholder="Nome da Ordem" value="${ordem}"></label>
          <label style="margin-top: 8px; display: block;">N√≠vel de Favor
            <select class="nivelFavor">
              <option value="Aliado" ${nivel === 'Aliado' ? 'selected' : ''}>Aliado (+2 em 1 teste ligado √† Ordem/sess√£o)</option>
              <option value="Confidente" ${nivel === 'Confidente' ? 'selected' : ''}>Confidente (Recursos/contatos, converter falha em sucesso/sess√£o)</option>
              <option value="Emiss√°rio" ${nivel === 'Emiss√°rio' ? 'selected' : ''}>Emiss√°rio (Pede grupo de apoio ou perd√£o social/sess√£o)</option>
            </select>
          </label>
          <label style="margin-top: 8px; display: block;">Benef√≠cios Adicionais<textarea placeholder="Benef√≠cios espec√≠ficos ou observa√ß√µes">${beneficios}</textarea></label>
        </div>
        <button class="btn small destructive remove-item">X</button>
      `;
      favoresOrdemList.appendChild(itemDiv);
      itemDiv.querySelectorAll("input, select, textarea").forEach(el => el.addEventListener("input", autoSave));
      itemDiv.querySelector(".remove-item").addEventListener("click", () => { itemDiv.remove(); autoSave(); });
      autoSave();
    }
    
    function updateConditionEffects() {
        const condition = $('#currentCondition').value;
        const effectsList = $('#conditionEffects');
        const effectsHTML = `<li><b>${condition}:</b> ${conditionEffectsData[condition]}</li>`;
        effectsList.innerHTML = effectsHTML;
        autoSave();
    }
    
    // --- Death Saves ---
    let deathSuccesses = 0;
    let deathFails = 0;

    function updateDeathSaves() {
        $('#deathSavesSuccess').textContent = deathSuccesses;
        $('#deathSavesFail').textContent = deathFails;
        autoSave();
    }
    
    function resetDeathSaves() {
        deathSuccesses = 0;
        deathFails = 0;
        updateDeathSaves();
        showMessageBox("Testes de morte resetados.");
    }
    
    function rollDeathSave() {
      if (parseInt($('#cur_pv').value) > 0) {
          showMessageBox("Voc√™ n√£o precisa rolar um teste de morte, pois seus PVs est√£o acima de 0.");
          return;
      }
      
      const roll = Math.floor(Math.random() * 20) + 1;
      $('#deathRoll').textContent = roll;
      
      const logText = `Teste de Morte: D20(${roll})`;
      const rollLog = $('#rollLog');
      const newRoll = document.createElement('div');
      
      if (roll >= 10) {
        deathSuccesses += (roll === 20) ? 2 : 1;
        newRoll.textContent = `${logText} -> Sucesso! (${deathSuccesses} sucesso(s) acumulados)`;
        newRoll.classList.add('ok');
      } else {
        deathFails += (roll === 1) ? 2 : 1;
        newRoll.textContent = `${logText} -> Falha! (${deathFails} falha(s) acumuladas)`;
        newRoll.classList.add('danger');
      }
      
      rollLog.prepend(newRoll);
      
      if (deathSuccesses >= 3) {
        showMessageBox("Voc√™ est√° estabilizado e seguro (por enquanto)!");
        resetDeathSaves();
      } else if (deathFails >= 3) {
        showMessageBox("Voc√™ morreu.");
        resetDeathSaves();
      }
      updateDeathSaves();
      autoSave();
    }

    // --- Campaign History ---
    function addCampaignEntry(id, data, isOpen = false) {
      const historyContainer = $('#campaignHistory');
      const entryDiv = document.createElement('div');
      entryDiv.id = `entry-${id}`;
      entryDiv.classList.add('entry');
      
      entryDiv.innerHTML = `
          <div class="entry-header">
              <h4>${data.campaignName || 'Nova Campanha'} - ${data.date ? new Date(data.date).toLocaleDateString('pt-BR') : 'Sem Data'}</h4>
              <button class="btn small destructive entry-delete-btn" data-id="${id}">X</button>
          </div>
          <div class="entry-content ${isOpen ? 'open' : ''}" id="entry-content-${id}">
              <label>Nome da Campanha<input type="text" class="campaign-name" value="${data.campaignName || ''}"></label>
              <label>Data<input type="date" class="campaign-date" value="${data.date || ''}"></label>
              <label>Resumo da Partida<textarea class="campaign-summary" placeholder="O que aconteceu nesta partida?">${data.summary || ''}</textarea></label>
              <label>Como o Personagem Contribuiu<textarea class="character-contribution" placeholder="O que seu personagem fez para influenciar a hist√≥ria?">${data.contribution || ''}</textarea></label>
              <label>Como a Hist√≥ria o Evoluiu<textarea class="character-evolution" placeholder="O que seu personagem aprendeu, ganhou ou mudou?">${data.evolution || ''}</textarea></label>
          </div>
      `;
      
      historyContainer.prepend(entryDiv);
      
      const deleteButton = entryDiv.querySelector('.entry-delete-btn');
      deleteButton.addEventListener('click', (e) => {
          e.stopPropagation(); 
          deleteCampaignEntry(id);
      });

      entryDiv.querySelector('.entry-header').addEventListener('click', () => {
          const content = $(`#entry-content-${id}`);
          content.classList.toggle('open');
      });

      entryDiv.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', autoSave));
    }
    
    function showNewEntryForm() {
        const form = $('#new-campaign-form');
        form.style.display = 'block';
        $('#addCampaignEntryBtn').style.display = 'none';
        
        $('#new-campaign-name').value = '';
        $('#new-campaign-date').value = new Date().toISOString().substring(0, 10);
        $('#new-campaign-summary').value = '';
        $('#new-character-contribution').value = '';
        $('#new-character-evolution').value = '';
    }

    function saveNewEntry() {
        const id = generateId();
        const newEntry = {
            id: id,
            campaignName: $('#new-campaign-name').value,
            date: $('#new-campaign-date').value,
            summary: $('#new-campaign-summary').value,
            contribution: $('#new-character-contribution').value,
            evolution: $('#new-character-evolution').value
        };
        
        if (!newEntry.campaignName) {
            showMessageBox("O nome da campanha √© obrigat√≥rio.");
            return;
        }

        if (!characterData[currentId].campaignHistory) {
            characterData[currentId].campaignHistory = [];
        }
        characterData[currentId].campaignHistory.push(newEntry);
        
        addCampaignEntry(id, newEntry, false);
        
        $('#new-campaign-form').style.display = 'none';
        $('#addCampaignEntryBtn').style.display = 'flex';
        
        autoSave();
    }

    function deleteCampaignEntry(id) {
        if (characterData[currentId] && characterData[currentId].campaignHistory) {
            const confirmation = showConfirmBox("Tem certeza que deseja excluir esta entrada? Esta a√ß√£o n√£o pode ser desfeita.");
            confirmation.then(isConfirmed => {
                if (isConfirmed) {
                    characterData[currentId].campaignHistory = characterData[currentId].campaignHistory.filter(entry => entry.id !== id);
                    $(`#entry-${id}`).remove();
                    autoSave();
                }
            });
        }
    }

    // --- Character Management ---
    function saveCharacter() {
      if (!currentId) return;

      const campaignHistory = [];
      $$('#campaignHistory .entry').forEach(entryDiv => {
          campaignHistory.push({
              id: entryDiv.id.replace('entry-', ''),
              campaignName: entryDiv.querySelector('.campaign-name').value,
              date: entryDiv.querySelector('.campaign-date').value,
              summary: entryDiv.querySelector('.campaign-summary').value,
              contribution: entryDiv.querySelector('.character-contribution').value,
              evolution: entryDiv.querySelector('.character-evolution').value
          });
      });

      const data = {
        nome: $('#nome').value,
        jogador: $('#jogador').value,
        classe: $('#classe').value,
        especie: $('#especie').value,
        traco: $('#traco').value,
        nivel: $('#nivel').value,
        alinhamento: $('#alinhamento').value,
        regiaoOrigem: $('#regiaoOrigem').value,
        talentoRegional: $('#talentoRegional').value,
        atributos: {},
        skills: [],
        recursos: {
          pv: { cur: $('#cur_pv').value, max: $('#max_pv').value },
          pe: { cur: $('#cur_pe').value, max: $('#max_pe').value },
          pa: { cur: $('#cur_pa').value, max: $('#max_pa').value },
          xp: { cur: $('#cur_xp').value, max: $('#max_xp').value },
          corrupcao: $('#corrupcaoSlider').value,
          velocidade: $('#velocidade').value,
          iniciativa: { bonus: $('#bonusIniciativa').value }
        },
        classes: [],
        bencaos: [],
        ataques: [],
        inventario: {
           dracmas: parseInt($('#dracmas').value) || 0,
            items: []
        },
        historia: {
            origem: $('#historia_origem').value,
            votos: $('#historia_votos').value,
            relacionamentos: $('#historia_relacionamentos').value,
            eventos: $('#historia_eventos').value,
        },
        notas: $('#notas').value,
        condicoes: $('#condicoes').value,
        pts_exp_espiritual: $('#pts_exp_espiritual').value,
        favoresOrdem: [],
        distribuicao: {
          cfg_pts: $('#cfg_pts').value,
          cfg_bonus6: $('#cfg_bonus6').value,
          cfg_falha: $('#cfg_falha').value
        },
        deathSaves: {
            successes: deathSuccesses,
            fails: deathFails
        },
        currentCondition: $('#currentCondition').value,
        campaignHistory: campaignHistory
      };

      ATTRIBUTES.forEach(attr => {
        data.atributos[attr] = parseInt($(`#val_${attr}`).dataset.val);
      });

      $$('#skillsBody tr').forEach(row => {
        data.skills.push({
          name: row.querySelector('input').value,
          attr: row.querySelector('.attrSelect').value,
          trained: row.querySelector('.trained').checked,
          specialized: row.querySelector('.specialized').checked,
          extra: parseInt(row.querySelector('.extra').value) || 0
        });
      });
      
      $$('#classesList .item').forEach(item => {
        data.classes.push({
          name: item.querySelector('input').value,
          desc: item.querySelector('textarea').value
        });
      });
      
      $$('#bencaosList .item').forEach(item => {
        data.bencaos.push({
          name: item.querySelector('input').value,
          desc: item.querySelector('textarea').value
        });
      });

      $$('#attacksList .item').forEach(item => {
        const inputs = item.querySelectorAll('input');
        data.ataques.push({
          name: inputs[0].value,
          bonus: inputs[1].value,
          damage: inputs[2].value,
          type: inputs[3].value
        });
      });
      
      $$('#itemsList .item.inventory').forEach(item => {
        data.inventario.items.push({
          name: item.querySelector('.item-nome').value,
          slots: parseFloat(item.querySelector('.item-slots').value),
          type: item.querySelector('.item-tipo').value,
          quantity: parseInt(item.querySelector('.item-qtd').value)
        });
      });

      $$('#favoresOrdemList .item').forEach(item => {
        data.favoresOrdem.push({
          ordem: item.querySelector('input').value,
          nivel: item.querySelector('.nivelFavor').value,
          beneficios: item.querySelector('textarea').value
        });
      });
      
      characterData[currentId] = data;
      localStorage.setItem('characterData', JSON.stringify(characterData));
      
      const option = $(`#characterSelect option[value="${currentId}"]`);
      if (option) {
        option.textContent = data.nome || `Personagem ${currentId.substring(0, 5)}`;
      }
    }

    function autoSave() {
        $('#autosave-text').textContent = 'Salvando...';
        $('#autosave-indicator').classList.remove('saved');
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }
        saveTimeout = setTimeout(() => {
            saveCharacter();
            $('#autosave-text').textContent = 'Salvo ‚úì';
            $('#autosave-indicator').classList.add('saved');
        }, 1000);
    }

    function loadCharacter(id) {
      if (!characterData[id]) return;
      const data = characterData[id];

      $('#nome').value = data.nome || '';
      $('#jogador').value = data.jogador || '';
      $('#classe').value = data.classe || '';
      $('#especie').value = data.especie || '';
      $('#traco').value = data.traco || '';
      $('#nivel').value = data.nivel || 1;
      $('#alinhamento').value = data.alinhamento || 'Fiel';
      $('#regiaoOrigem').value = data.regiaoOrigem || '';
      $('#talentoRegional').value = data.talentoRegional || '';
      
      if (data.recursos) {
          const rec = data.recursos;
          if (rec.pv) {
            $('#cur_pv').value = rec.pv.cur || 10;
            $('#max_pv').value = rec.pv.max || 10;
          }
          if (rec.pe) {
            $('#cur_pe').value = rec.pe.cur || 10;
            $('#max_pe').value = rec.pe.max || 10;
          }
          if (rec.pa) {
            $('#cur_pa').value = rec.pa.cur || 10;
            $('#max_pa').value = rec.pa.max || 10;
          }
          if (rec.xp) {
            $('#cur_xp').value = rec.xp.cur || 0;
            $('#max_xp').value = rec.xp.max || 1000;
          }
          $('#corrupcaoSlider').value = rec.corrupcao || 0;
          updateCorrupcao(); 
          $('#velocidade').value = rec.velocidade || 9;
          if (rec.iniciativa) {
            $('#bonusIniciativa').value = rec.iniciativa.bonus || 0;
          }
          updateIniciativa();
      }

      if (data.distribuicao) {
        $('#cfg_pts').value = data.distribuicao.cfg_pts;
        $('#cfg_bonus6').value = data.distribuicao.cfg_bonus6;
        $('#cfg_falha').value = data.distribuicao.cfg_falha;
      }
      
      ATTRIBUTES.forEach(attr => {
        const val = data.atributos[attr] || 10;
        const attrEl = $(`#val_${attr}`);
        attrEl.dataset.val = val;
        attrEl.textContent = val;
        const mod = getAttrMod(attr);
        $(`#mod_${attr}`).textContent = `mod ${mod > 0 ? '+' : ''}${mod}`;
      });
      
      if (data.deathSaves) {
          deathSuccesses = data.deathSaves.successes || 0;
          deathFails = data.deathSaves.fails || 0;
          updateDeathSaves();
      }
      
      $('#currentCondition').value = data.currentCondition || 'Saud√°vel';
      updateConditionEffects();

      $('#skillsBody').innerHTML = '';
      if (data.skills) { data.skills.forEach(s => addSkillRow(s.name, s.attr, s.trained, s.specialized, s.extra)); }
      
      $('#classesList').innerHTML = '';
      if (data.classes) { data.classes.forEach(c => addClasse(c.name, c.desc)); }
      
      $('#bencaosList').innerHTML = '';
      if (data.bencaos) { data.bencaos.forEach(b => addBencao(b.name, b.desc)); }
      
      $('#attacksList').innerHTML = '';
      if (data.ataques) { data.ataques.forEach(a => addAttack(a.name, a.bonus, a.damage, a.type)); }
      
      $('#itemsList').innerHTML = '';
        $('#dracmas').value = data.inventario.dracmas || 0;
      if (data.inventario && data.inventario.items) { data.inventario.items.forEach(i => addItem(i.name, i.slots, i.type, i.quantity)); }

      $('#favoresOrdemList').innerHTML = '';
      if (data.favoresOrdem) { data.favoresOrdem.forEach(fo => addFavorOrdem(fo.ordem, fo.nivel, fo.beneficios)); }

      if (data.historia && typeof data.historia === 'object') {
        $('#historia_origem').value = data.historia.origem || '';
        $('#historia_votos').value = data.historia.votos || '';
        $('#historia_relacionamentos').value = data.historia.relacionamentos || '';
        $('#historia_eventos').value = data.historia.eventos || '';
      } else {
        $('#historia_origem').value = data.historia || '';
        $('#historia_votos').value = '';
        $('#historia_relacionamentos').value = '';
        $('#historia_eventos').value = '';
      }
      $('#notas').value = data.notas || '';
      $('#condicoes').value = data.condicoes || '';
      $('#pts_exp_espiritual').value = data.pts_exp_espiritual || 0;

      $('#campaignHistory').innerHTML = '';
      if (data.campaignHistory) {
          data.campaignHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
          data.campaignHistory.forEach(entry => addCampaignEntry(entry.id, entry, false));
      }
      
      updatePoints();
      calculateSlots();
      recalcAllSkills();
      updateKPI('pv');
      updateKPI('pe');
      updateKPI('pa');
      updateKPI('xp');
      atualizarEspecie();
    }

    function resetCharacterData() {
        return {
          nome: "Novo Personagem",
          jogador: "",
          classe: "",
          especie: "",
          traco: "",
          nivel: 1,
          alinhamento: "Fiel",
          regiaoOrigem: "",
          talentoRegional: "",
          atributos: {
            FOR: 10, AGI: 10, VIG: 10, AST: 10, SAB: 10, CAR: 10, FE: 10
          },
          skills: [],
          recursos: {
            pv: { cur: 10, max: 10 },
            pe: { cur: 10, max: 10 },
            pa: { cur: 10, max: 10 },
            xp: { cur: 0, max: 1000 },
            corrupcao: 0,
            velocidade: 9,
            iniciativa: { bonus: 0 }
          },
          classes: [],
          bencaos: [],
          ataques: [],
          inventario: {
                  dracmas: 20,
              items: []
          },
          historia: {
              origem: "",
              votos: "",
              relacionamentos: "",
              eventos: ""
          },
          notas: "",
          condicoes: "",
          pts_exp_espiritual: 0,
          favoresOrdem: [],
          distribuicao: {
            cfg_pts: 10,
            cfg_bonus6: 2,
            cfg_falha: "true"
          },
          deathSaves: {
              successes: 0,
              fails: 0
          },
          currentCondition: 'Saud√°vel',
          campaignHistory: []
        };
    }

    function updateCharacterList() {
        const select = $('#characterSelect');
        select.innerHTML = '';
        const keys = Object.keys(characterData);
        if (keys.length === 0) {
            const newId = generateId();
            characterData[newId] = resetCharacterData();
            currentId = newId;
        }

        for (const id in characterData) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = characterData[id].nome || `Personagem ${id.substring(0, 5)}`;
            select.appendChild(option);
        }
        select.value = currentId;
    }

    function newCharacter() {
        const newId = generateId();
        characterData[newId] = resetCharacterData();
        currentId = newId;
        
        loadCharacter(currentId);
        updateCharacterList();
        saveCharacter();
        
        showMessageBox("Nova ficha criada!");
    }


    function duplicateCharacter() {
        const newId = generateId();
        const currentData = JSON.parse(JSON.stringify(characterData[currentId]));
        currentData.nome = `${currentData.nome} (C√≥pia)`;
        characterData[newId] = currentData;
        currentId = newId;

        loadCharacter(currentId);
        updateCharacterList();
        saveCharacter();

        showMessageBox("Ficha duplicada!");
    }

    async function deleteCharacter() {
      if (Object.keys(characterData).length <= 1) {
        showMessageBox("Voc√™ n√£o pode excluir a √∫ltima ficha.");
        return;
      }
      const confirmation = await showConfirmBox("Tem certeza que deseja excluir esta ficha? Esta a√ß√£o n√£o pode ser desfeita.");
      
      if (confirmation) {
        delete characterData[currentId];
        const newId = Object.keys(characterData)[0];
        currentId = newId;

        localStorage.setItem('characterData', JSON.stringify(characterData));
        updateCharacterList();
        loadCharacter(currentId);

        showMessageBox("Ficha exclu√≠da com sucesso.");
      }
    }
    
    function exportCurrent() {
      const dataStr = JSON.stringify(characterData[currentId], null, 2);
      const blob = new Blob([dataStr], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const charName = characterData[currentId].nome.replace(/ /g, '_') || 'personagem';
      a.download = `${charName}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showMessageBox("Ficha exportada como JSON.");
    }
    
    function isObject(item) {
        return (item && typeof item === 'object' && !Array.isArray(item));
    }

    function deepMerge(target, ...sources) {
        if (!sources.length) return target;
        const source = sources.shift();

        if (isObject(target) && isObject(source)) {
            for (const key in source) {
                if (isObject(source[key])) {
                    if (!target[key]) Object.assign(target, { [key]: {} });
                    deepMerge(target[key], source[key]);
                } else {
                    Object.assign(target, { [key]: source[key] });
                }
            }
        }
        return deepMerge(target, ...sources);
    }
    
    function importFrom(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          const newId = generateId();

          const defaultSheet = resetCharacterData();
          
          const finalSheet = deepMerge(defaultSheet, importedData);
          
          if (typeof importedData.historia === 'string') {
              finalSheet.historia.origem = importedData.historia;
          }

          characterData[newId] = finalSheet;
          currentId = newId;
          
          updateCharacterList();
          
          loadCharacter(currentId);
          
          saveCharacter();
          
          showMessageBox("Ficha importada com sucesso!");
          
        } catch (error) {
          console.error("Erro na importa√ß√£o:", error);
          showMessageBox("Erro ao importar o arquivo. Verifique se √© um arquivo JSON v√°lido e compat√≠vel.");
        }
      };
      reader.readAsText(file);
    }

    async function handlePrintAndSaveAsPDF() {
      await showMessageBox("Para salvar a ficha como PDF, selecione 'Salvar como PDF' na lista de impressoras do seu navegador ap√≥s a janela de impress√£o ser aberta.");
      window.print();
    }
    
    function setEventListeners() {
      $$('input, textarea, select').forEach(el => {
        el.addEventListener('input', autoSave);
        el.addEventListener('change', autoSave);
      });

      $$('.tab').forEach(tab => tab.addEventListener('click', (e) => {
        $$('.tab').forEach(t => t.classList.remove('active'));
        $$('.pane').forEach(p => p.classList.remove('active'));
        e.currentTarget.classList.add('active');
        $(`[data-pane="${e.currentTarget.dataset.open}"]`).classList.add('active');
      }));

      $$('#attrGrid .btn').forEach(btn => btn.addEventListener('click', handleAttrChange));
      
      $$('#cur_pv, #max_pv').forEach(input => input.addEventListener('input', () => updateKPI('pv')));
      $$('#cur_pe, #max_pe').forEach(input => input.addEventListener('input', () => updateKPI('pe')));
      $$('#cur_pa, #max_pa').forEach(input => input.addEventListener('input', () => updateKPI('pa')));
      $$('#cur_xp, #max_xp').forEach(input => input.addEventListener('input', () => updateKPI('xp')));
      
      $('#corrupcaoSlider').addEventListener('input', updateCorrupcao);
      $('#bonusIniciativa').addEventListener('input', updateIniciativa);
      
      $('#addDeathSuccess').addEventListener('click', () => { deathSuccesses++; updateDeathSaves(); });
      $('#minusDeathSuccess').addEventListener('click', () => { if (deathSuccesses > 0) deathSuccesses--; updateDeathSaves(); });
      $('#addDeathFail').addEventListener('click', () => { deathFails++; updateDeathSaves(); });
      $('#minusDeathFail').addEventListener('click', () => { if (deathFails > 0) deathFails--; updateDeathSaves(); });
      $('#rollDeathSaveBtn').addEventListener('click', rollDeathSave);
      $('#resetDeathSavesBtn').addEventListener('click', resetDeathSaves);
      
      $('#currentCondition').addEventListener('change', updateConditionEffects);
      
      $('#addSkillBtn').addEventListener('click', addCustomSkill);
      $('#addClasseBtn').addEventListener('click', () => addClasse()); 
      $('#addBencaoBtn').addEventListener('click', () => addBencao()); 
      $('#addItemBtn').addEventListener('click', () => addItem());
      $('#addAttackBtn').addEventListener('click', () => addAttack());
      $('#rollIniciativaBtn').addEventListener('click', rollIniciativa);
      $('#addFavorOrdemBtn').addEventListener('click', () => addFavorOrdem());
      $('#addCampaignEntryBtn').addEventListener('click', showNewEntryForm);
      $('#cancelNewEntryBtn').addEventListener('click', () => {
          $('#new-campaign-form').style.display = 'none';
          $('#addCampaignEntryBtn').style.display = 'flex';
      });
      $('#saveNewEntryBtn').addEventListener('click', saveNewEntry);
      
      $('#newCharBtn').addEventListener('click', newCharacter);
      $('#dupCharBtn').addEventListener('click', duplicateCharacter);
      $('#delCharBtn').addEventListener('click', deleteCharacter);
      $('#exportBtn').addEventListener('click', exportCurrent);
      $('#importFile').addEventListener('change', e => { if(e.target.files[0]) importFrom(e.target.files[0]); e.target.value = ''; });
      $('#printBtn').addEventListener('click', handlePrintAndSaveAsPDF);
      $('#saveBtn').addEventListener('click', () => { saveCharacter(); showMessageBox("Salvamento manual conclu√≠do!"); });
      $('#characterSelect').addEventListener('change', e => {
        saveCharacter();
        currentId = e.target.value;
        loadCharacter(currentId);
      });
      $('#themeBtn').addEventListener('click', () => {
        const theme = document.body.getAttribute('data-theme');
        document.body.setAttribute('data-theme', theme === 'dark' ? 'light' : 'dark');
      });

      $('#pts_exp_espiritual').addEventListener('input', autoSave);
      $('#regiaoOrigem').addEventListener('change', autoSave);
      $('#talentoRegional').addEventListener('input', autoSave);
    }

    function populateLoreSections() {
      const regioesContainer = $('#regioesLore');
      regioesContainer.innerHTML = regioesLoreData.map(regiao => `
        <details class="card" style="margin-bottom: 8px;">
          <summary><b>${regiao.name}</b></summary>
          <p class="hint" style="margin-top: 8px;">${regiao.desc}</p>
        </details>
      `).join('');

      const bencaosContainer = $('#bencaosComunsLore');
      bencaosContainer.innerHTML = bencaosComunsLoreData.map(bencao => `
        <details class="card" style="margin-bottom: 8px;">
          <summary><b>${bencao.name}</b></summary>
          <p class="hint" style="margin-top: 8px;"><b>Efeito:</b> ${bencao.effect}<br><b>Dura√ß√£o:</b> ${bencao.duration}</p>
        </details>
      `).join('');
    }

    function init() {
      const storedData = localStorage.getItem('characterData');
      if (storedData) {
        characterData = JSON.parse(storedData);
        currentId = Object.keys(characterData)[0];
      } else {
        const newId = generateId();
        characterData[newId] = resetCharacterData();
        currentId = newId;
        localStorage.setItem('characterData', JSON.stringify(characterData));
      }
      
      updateCharacterList();
      loadCharacter(currentId);
      setEventListeners();
      autoSave();
      populateLoreSections();
    }
    
    window.onload = init;
  </script>
</body>
</html>
